<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mypageMapper">

	<resultMap id="PointResultSet" type="Point">
		<id property="ptno" column="POINT_NO"/>
		<result property="memno" column="MEM_NO"/>
		<result property="ordno" column="ORD_NO"/>
		<result property="pt_date" column="POINT_DATE"/>
		<result property="pt_price" column="POINT_PRICE"/>
		<result property="pt_content" column="POINT_CONTENT"/>
		<result property="pt_duedate" column="POINT_DUEDATE"/>
		<result property="pt_part" column="POINT_PART"/>
	</resultMap>

	<resultMap id="CouponMemResultSet" type="CouponMem">
		<id property="cpmem_no" column="CPMEM_NO"/>
		<result property="memno" column="MEM_NO"/>
		<result property="cpno" column="CP_NO"/>
		<result property="cpdate" column="CP_DATE"/>
		<result property="cpusing" column="CP_USING"/>
		<result property="cp_usedate" column="CP_USE_DATE"/>
		<result property="cpname" column="CP_NAME"/>
		<result property="cpdiscount" column="CP_DISCOUNT"/>
	</resultMap>

	<resultMap id="MyBoardResultSet" type="MyBoard">
		<id property="qna_no" column="QNA_NO"/>
		<result property="memno" column="MEM_NO"/>
		<result property="b_cate_no" column="B_CATE_NO"/>
		<result property="b_cate_name" column="B_CATE_NAME"/>
		<result property="qna_date" column="QNA_DATE"/>
		<result property="qna_writer" column="QNA_WRITER"/>
		<result property="qna_title" column="QNA_TITLE"/>
		<result property="qna_secure" column="QNA_SECURE"/>
		<result property="qna_chk" column="QNA_CHK"/>

	</resultMap>

	<resultMap id="ordResultSet" type="Ord">
		<id property="ord_no" column="ORD_NO"/>
		<result property="ord_detailno" column="ORD_DETAILNO"/>
		<result property="memNo" column="MEM_NO"/>
		<result property="prdt_no" column="PRDT_NO"/>
		<result property="ord_date" column="ORD_DATE"/>
		<result property="ord_receiver" column="ORD_RECEIVER"/>
		<result property="ord_phone" column="ORD_PHONE"/>
		<result property="ord_address" column="ORD_ADDRESS"/>
		<result property="ord_message" column="ORD_MESSAGE"/>
		<result property="ord_status" column="ORD_STATUS"/>
		<result property="ord_size" column="ORD_SIZE"/>
		<result property="ord_color" column="ORD_COLOR"/>
		<result property="ord_count" column="ORD_COUNT"/>
		<result property="path" column="PRDT_IMAGE_PATH"/>
		<result property="image" column="PRDT_IMAGE"/>
		<result property="prdt_name" column="PRDT_NAME"/>
		<result property="prdt_price" column="PRDT_PRICE"/>
		<result property="prdt_sumprice" column="PRDT_SUMPRICE"/>
	</resultMap>


	<resultMap id="AddressResultMap" type="Address">
		<id property="adNo" column="AD_NO"/>
		<result property="memNo" column="MEM_NO"/>
		<result property="adTitle" column="AD_TITLE"/>
		<result property="adReceiver" column="AD_RECEIVER"/>
		<result property="adAddress" column="AD_ADDRESS"/>
		<result property="adPhone" column="AD_PHONE"/>
	</resultMap>

	<resultMap id="DIBSResultMap" type="DIBS">
		<id property="dibsno" column="DIBS_NO"/>
		<result property="memno" column="MEM_NO"/>
		<result property="prdt_no" column="PRDT_NO"/>
		<result property="dibs_count" column="DIBS_COUNT"/>
		<result property="dibs_size" column="DIBS_SIZE"/>
		<result property="dibs_color" column="DIBS_COLOR"/>
		<result property="prdt_name" column="PRDT_NAME"/>
		<result property="prdt_price" column="PRDT_PRICE"/>
		<result property="prdt_sumprice" column="PRDT_SUMPRICE"/>
		<result property="path" column="PRDT_IMAGE_PATH"/>
		<result property="image" column="PRDT_IMAGE"/>
		<result property="dibs_date" column="DIBS_DATE"/>
		<result property="prdt_color" column="OPT_COLOR"/>
		<result property="prdt_size" column="OPT_SIZE"/>
	</resultMap>
	
	



	<select id="PointListCount" resultType="_int">
		SELECT COUNT(*)
		FROM POINT
		WHERE MEM_NO=#{memNo}
	</select>

	<select id="PointselectList" resultMap="PointResultSet">
		SELECT *
		FROM POINT
		WHERE MEM_NO=#{memNo}
		ORDER BY POINT_NO DESC
	</select>

	<select id="PointUnavailListCount" resultType="_int">
		SELECT COUNT(*)
		FROM POINT
		WHERE MEM_NO=#{memNo}

	</select>

	<select id="PointselectUnavailList" resultMap="PointResultSet">
		SELECT *
		FROM POINT
		WHERE MEM_NO=#{memNo}
		ORDER BY POINT_NO DESC
	</select>

	<select id="CouponListCount" resultType="_int" parameterType="Member">
		SELECT COUNT(*)
		FROM COUPON C
		JOIN COUPON_MEM CM
		ON (C.CP_NO = CM.CP_NO)
		WHERE MEM_NO=#{memNo}
		AND CP_USING='N'
	</select>

	<select id="CouponSelectList" resultMap="CouponMemResultSet">
		SELECT *
		FROM COUPON C
		JOIN COUPON_MEM CM
		ON (C.CP_NO = CM.CP_NO)
		WHERE MEM_NO=#{memNo}
		AND CP_USING='N'
		ORDER BY CPMEM_NO DESC
	</select>

	<select id="CompleteCouponListCount" resultType="_int" parameterType="Member">
		SELECT COUNT(*)
		FROM COUPON C
		JOIN COUPON_MEM CM
		ON (C.CP_NO = CM.CP_NO)
		WHERE MEM_NO=#{memNo}
		AND CP_USING='Y'
	</select>

	<select id="CompleteCouponSelectList" resultMap="CouponMemResultSet">
		SELECT *
		FROM COUPON C
		JOIN COUPON_MEM CM
		ON (C.CP_NO = CM.CP_NO)
		WHERE MEM_NO=#{memNo}
		AND CP_USING='Y'
		ORDER BY CPMEM_NO DESC
	</select>

<!-- 	<select id="selectPoint" resultType="_int">
		SELECT SUM(DECODE(POINT_PART,'적립',1*POINT_PRICE,'사용',-1*POINT_PRICE)) AS PointSum
		FROM POINT
		WHERE MEM_NO=#{memNo}
	</select>
	 -->
	<update id="updatePoint" parameterType="Member">
		UPDATE MEMBER
		SET MEM_POINT=(SELECT SUM(DECODE(POINT_PART,'적립',1*POINT_PRICE,'사용',-1*POINT_PRICE)) AS PointSum
		FROM POINT
		WHERE MEM_NO=#{memNo}) + #{mem_point}
		WHERE MEM_NO=#{memNo}
	</update>

	<select id="selectBoardListCount" resultType="_int">
		SELECT COUNT(*)
        FROM QNA Q
        JOIN BOARD_CATEGORY MB
        ON (Q.B_CATE_NO = MB.B_CATE_NO)
        WHERE MEM_NO=#{memNo}
        ORDER BY QNA_NO DESC
	</select>

	<select id="selectBoardList" resultMap="MyBoardResultSet">
		SELECT *
        FROM QNA Q
        JOIN BOARD_CATEGORY MB
        ON (Q.B_CATE_NO = MB.B_CATE_NO)
        WHERE MEM_NO=#{memno}
        ORDER BY QNA_NO DESC
	</select>

	<select id="SearchListCount" resultType="_int">
		SELECT COUNT(*)
		FROM QNA Q
		JOIN BOARD_CATEGORY MB
		ON (Q.B_CATE_NO = MB.B_CATE_NO)
		WHERE MEM_NO=#{memno}
		<if test="writer != null">
		AND Q.QNA_WRITER LIKE '%' || #{writer} || '%'
		</if>
		<if test="title != null">
		AND Q.QNA_TITLE LIKE '%' || #{title} || '%'
		</if>
		ORDER BY QNA_NO DESC
	</select>

	<select id="selectSearchList" resultMap="MyBoardResultSet">
		SELECT *
		FROM QNA Q
		JOIN BOARD_CATEGORY MB
		ON (Q.B_CATE_NO = MB.B_CATE_NO)
		WHERE MEM_NO=#{memno}
		<if test="writer != null">
		AND Q.QNA_WRITER LIKE '%' || #{writer} || '%'
		</if>
		<if test="title != null">
		AND Q.QNA_TITLE LIKE '%' || #{title} || '%'
		</if>
		ORDER BY QNA_NO DESC
	</select>

	<select id="getOrderListCount" resultType="_int">
		SELECT COUNT(*)
		FROM ORD
		WHERE MEM_NO=#{memNo}

	</select>

	<select id="selectOrderList" resultMap="ordResultSet">
		SELECT O.*, P.*, (O.ORD_COUNT * P.PRDT_PRICE) AS PRDT_SUMPRICE
		FROM ORD O
		JOIN PRDT P
		ON (O.PRDT_NO = P.PRDT_NO)
		WHERE MEM_NO=#{memno}
		ORDER BY O.ORD_DATE DESC
	</select>


	<insert id="mAddressInsert" parameterType="Address">
		INSERT INTO ADDRESS VALUES
		(AD_SEQ.NEXTVAL, #{memNo}, #{adTitle},#{adReceiver},#{adAddress},#{adPhone})
	</insert>

	<select id="getAddressCount" resultType="_int" parameterType="_int">
		SELECT COUNT(*)
		FROM ADDRESS
		WHERE MEM_NO=#{memNo}

	</select>

	<select id="selectAddressList" parameterType="Member" resultMap="AddressResultMap">
		SELECT *
		FROM ADDRESS
		WHERE MEM_NO=#{memNo}

	</select>

	<select id="ModifyAddress" parameterType="_int" resultMap="AddressResultMap">
		SELECT *
		FROM ADDRESS
		WHERE AD_NO=#{mAddress}

	</select>

	<update id="AddressUpdate" parameterType="Address">
		UPDATE ADDRESS
		SET AD_TITLE=#{adTitle}, AD_RECEIVER=#{adReceiver}, AD_ADDRESS=#{adAddress},
		AD_PHONE=#{adPhone}
		WHERE AD_NO=#{adNo}
	</update>

	<delete id="AddressDelete" parameterType="java.util.Map">
		<foreach  item="a" collection="nokArr"  index="index"
		      separator=";" open="DECLARE BEGIN" close="; END;" >
		DELETE
		FROM ADDRESS
		WHERE AD_NO=#{a.adNo}
		</foreach>
	</delete>

	<select id ="SearchOrdListCount" resultType="_int">
		SELECT COUNT(*)
		FROM ORD O
		JOIN PRDT P
		ON (O.PRDT_NO = P.PRDT_NO)
		WHERE MEM_NO=#{memno}
		<if test="ord_status.equals('all')">
		AND ORD_DATE BETWEEN #{start_date} AND #{end_date}
		AND (ORD_STATUS='A' OR ORD_STATUS='B' OR ORD_STATUS='C' OR ORD_STATUS='D' OR ORD_STATUS='E')
		</if>

		<if test="!ord_status.equals('all')">
		AND ORD_DATE BETWEEN #{start_date} AND #{end_date}
		AND ORD_STATUS=#{ord_status}
		</if>

	</select>

	<select id="selectSearchOrdList" resultMap="ordResultSet">
		SELECT O.*, P.*, (O.ORD_COUNT * P.PRDT_PRICE) AS PRDT_SUMPRICE
		FROM ORD O
		JOIN PRDT P
		ON (O.PRDT_NO = P.PRDT_NO)
		WHERE MEM_NO=#{memno}
		<if test="ord_status.equals('all')">
		AND ORD_DATE BETWEEN #{start_date} AND #{end_date}
		AND (ORD_STATUS='A' OR ORD_STATUS='B' OR ORD_STATUS='C' OR ORD_STATUS='D' OR ORD_STATUS='E')
		</if>
		<if test="!ord_status.equals('all')">
		AND ORD_DATE BETWEEN #{start_date} AND #{end_date}
		AND ORD_STATUS=#{ord_status}
		</if>
		ORDER BY O.ORD_DATE DESC
	</select>

	<select id="orderCount1" resultType="_int" parameterType="_int" >
		SELECT COUNT(*)
		FROM ORD
		WHERE MEM_NO = #{memNo}
		AND ORD_STATUS = 'A'
	</select>
	<select id="orderCount2" resultType="_int" parameterType="_int" >
		SELECT COUNT(*)
		FROM ORD
		WHERE MEM_NO = #{memNo}
		AND ORD_STATUS = 'B'
	</select>
	<select id="orderCount3" resultType="_int" parameterType="_int" >
		SELECT COUNT(*)
		FROM ORD
		WHERE MEM_NO = #{memNo}
		AND ORD_STATUS = 'C'
	</select>
	<select id="orderCount4" resultType="_int" parameterType="_int" >
		SELECT COUNT(*)
		FROM ORD
		WHERE MEM_NO = #{memNo}
		AND ORD_STATUS = 'D'
	</select>
	<select id="orderCount5" resultType="_int" parameterType="_int" >
		SELECT COUNT(*)
		FROM ORD
		WHERE MEM_NO = #{memNo}
		AND ORD_STATUS = 'E'
	</select>

	<select id="getCancelListCount" resultType="_int">
		SELECT COUNT(*)
		FROM ORD
		WHERE MEM_NO=#{memNo}
		AND ORD_STATUS='E'
	</select>

	<select id="selectCancelList" resultMap="ordResultSet">
		SELECT O.*, P.*, (O.ORD_COUNT * P.PRDT_PRICE) AS PRDT_SUMPRICE
		FROM ORD O
		JOIN PRDT P
		ON (O.PRDT_NO = P.PRDT_NO)
		WHERE MEM_NO=#{memno}
		AND ORD_STATUS='E'
		ORDER BY O.ORD_DATE DESC

	</select>

	<select id="getSearchCancelCount" resultType="_int">
		SELECT COUNT(*)
		FROM ORD O
		JOIN PRDT P
		ON (O.PRDT_NO = P.PRDT_NO)
		WHERE MEM_NO=#{memno}
		AND ORD_DATE BETWEEN #{start_date} AND #{end_date}
		AND ORD_STATUS='E'
	</select>

	<select id="selectSearchCancelList" resultMap="ordResultSet">
		SELECT O.*, P.*, (O.ORD_COUNT * P.PRDT_PRICE) AS PRDT_SUMPRICE
		FROM ORD O
		JOIN PRDT P
		ON (O.PRDT_NO = P.PRDT_NO)
		WHERE MEM_NO=#{memno}
		AND ORD_DATE BETWEEN #{start_date} AND #{end_date}
		AND ORD_STATUS='E'
	</select>

	<select id="getWishListCount" resultType="_int">
	SELECT COUNT(*)
     FROM DIBS D
     JOIN PRDT P
     ON (D.PRDT_NO = P.PRDT_NO)
     WHERE MEM_NO=#{memno}
	</select>

	<insert id="ReturnInsert" parameterType="Return">
		INSERT INTO RETURN VALUES
		(RE_SEQ.NEXTVAL,#{memCode},#{ordCode},SYSDATE,#{reName},#{reTitle},#{content},#{reReason},
		NULL,NULL,SYSDATE,NULL,'N')
	</insert>
		
	<select id="selectWishList" resultMap="DIBSResultMap">
	 SELECT *
     FROM DIBS D
     JOIN PRDT P
     ON (D.PRDT_NO = P.PRDT_NO)
     WHERE MEM_NO=#{memno}
	</select>

	<select id="selectOptionList1" resultMap="DIBSResultMap">
	 SELECT PRDT_NO, OPT_COLOR
	 FROM PRDT_OPT
	 WHERE PRDT_NO=#{prdt_no}
	 GROUP BY PRDT_NO, OPT_COLOR
	</select>
	
	<select id="selectOptionList2" resultMap="DIBSResultMap">
	 SELECT PRDT_NO, OPT_SIZE
	 FROM PRDT_OPT
	 WHERE PRDT_NO=#{prdt_no}
	 GROUP BY PRDT_NO, OPT_SIZE
	
	</select>
	
	<insert id="insertwishlist" parameterType="DIBS">
	INSERT INTO DIBS
	VALUES(DIBS_SEQ.NEXTVAL, #{memno}, #{prdt_no},#{dibs_count},#{dibs_color},#{dibs_size},default )
	
	</insert>
	
	<select id="selectonelist" resultMap="DIBSResultMap">
	 SELECT *
     FROM (select * from dibs order by dibs_no desc) D
     JOIN PRDT P
     ON (D.PRDT_NO = P.PRDT_NO)
     where rownum=1
	
	
	</select>
	
</mapper>
